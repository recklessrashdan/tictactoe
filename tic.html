<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe with Score</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px; /* Space between main sections */
        }

        /* Game Container Styling */
        .game-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Game Board Display */
        #game-board-display {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            font-size: 1.5em;
            line-height: 1.5;
            text-align: center;
            max-width: 300px;
            overflow-x: auto;
        }

        /* Message Display */
        #message-display {
            background-color: #e8f5e9;
            color: #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: 600;
            border: 1px solid #d4edda;
        }

        /* Input Section */
        .input-section {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .input-section label {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #555;
        }

        .input-section input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1.1em;
            width: 80px;
            text-align: center;
            -moz-appearance: textfield;
        }

        .input-section input[type="number"]::-webkit-outer-spin-button,
        .input-section input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Button Styling */
        .input-section button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .input-section button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .input-section button:active {
            background-color: #21618c;
            transform: translateY(0);
        }

        .reset-button {
            background-color: #e74c3c;
            margin-top: 25px;
        }

        .reset-button:hover {
            background-color: #c0392b;
        }

        .reset-button:active {
            background-color: #922b21;
        }

        /* Scoreboard Styling */
        .scoreboard {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .score-item {
            font-size: 1.2em;
            font-weight: 600;
            color: #555;
        }

        .score-item span {
            color: #3498db;
            font-size: 1.4em;
            font-weight: 700;
            margin-left: 5px;
        }

        .score-item.x-score span { color: #e74c3c; } /* Red for X */
        .score-item.o-score span { color: #2ecc71; } /* Green for O */
        .score-item.draw-score span { color: #f39c12; } /* Orange for Draw */

        /* User ID Display */
        #user-id-display {
            margin-top: 10px;
            font-size: 0.9em;
            color: #777;
            word-break: break-all; /* Break long IDs */
            text-align: center;
            padding: 0 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .game-container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            #game-board-display {
                font-size: 1.2em;
                padding: 15px;
            }
            .input-section input[type="number"],
            .input-section button {
                font-size: 1em;
                padding: 10px 20px;
            }
            .scoreboard {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Tic-Tac-Toe</h1>
        <div id="user-id-display">Loading user ID...</div>
        <!-- Scoreboard -->
        <div class="scoreboard">
            <div class="score-item x-score">X Wins: <span id="x-wins">0</span></div>
            <div class="score-item o-score">O Wins: <span id="o-wins">0</span></div>
            <div class="score-item draw-score">Draws: <span id="draws">0</span></div>
        </div>

        <div id="game-board-display"></div>
        <div id="message-display">Loading game...</div>

        <div class="input-section">
            <label for="moveInput">Enter your move (1-9):</label>
            <input type="number" id="moveInput" min="1" max="9" placeholder="1-9">
            <button id="makeMoveButton">Make Move</button>
            <button id="resetGameButton" class="reset-button">Play Again</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Game State Variables ---
        let board;
        let currentPlayer;
        let gameActive;
        let scores = { X: 0, O: 0, Draw: 0 }; // Scores object

        // --- Firebase Variables ---
        let app;
        let db;
        let auth;
        let userId = 'loading...'; // Default until authenticated
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth
        let scoresDocRef; // Reference to the Firestore document storing scores

        // --- Get References to HTML Elements ---
        const boardDisplay = document.getElementById('game-board-display');
        const messageDisplay = document.getElementById('message-display');
        const moveInput = document.getElementById('moveInput');
        const makeMoveButton = document.getElementById('makeMoveButton');
        const resetGameButton = document.getElementById('resetGameButton');
        const xWinsDisplay = document.getElementById('x-wins');
        const oWinsDisplay = document.getElementById('o-wins');
        const drawsDisplay = document.getElementById('draws');
        const userIdDisplay = document.getElementById('user-id-display');

        /**
         * Initializes Firebase and sets up authentication.
         * This runs once when the script loads.
         */
        async function initializeFirebase() {
            try {
                // =================================================================================================
                // YOUR FIREBASE PROJECT CONFIGURATION (NOW FILLED IN)
                // This has been updated with the details you provided.
                // =================================================================================================
                const firebaseConfig = {
                  apiKey: "AIzaSyC7QcanFFlVX_8E9EpyyDMDtOkHKFG9o6M",
                  authDomain: "tic-tac-toe-2d84f.firebaseapp.com",
                  projectId: "tic-tac-toe-2d84f",
                  storageBucket: "tic-tac-toe-2d84f.firebasestorage.app",
                  messagingSenderId: "519284949186",
                  appId: "1:519284949186:web:7bb82420ae5d7e66507b5b",
                  measurementId: "G-9D1E8H7YVP"
                };

                // For GitHub Pages or similar deployments, we use the projectId as the appId for Firestore paths.
                // This is a fallback if __app_id is not defined (e.g., outside Canvas environment).
                const appId = firebaseConfig.projectId;

                // No longer checking for placeholder values here as they are now filled.
                console.log("Initializing Firebase with config:", firebaseConfig);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Load scores after authentication is ready
                        loadScores(appId); // Pass appId to loadScores
                        initializeGame(); // Initialize game after auth and scores load
                    } else {
                        // User is signed out, attempt anonymous sign-in
                        console.log("No user signed in. Attempting anonymous sign-in...");
                        try {
                            // On GitHub Pages, __initial_auth_token is not available, so we always sign in anonymously.
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Auth Error during anonymous sign-in:", error);
                            setMessage(`Authentication Error: ${error.message}. Scores will not be saved.`);
                            userIdDisplay.textContent = `Error getting User ID.`;
                            isAuthReady = false;
                            initializeGame(); // Still initialize game even if auth fails
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to initialize Firebase (outer catch):", error);
                setMessage(`Error initializing Firebase: ${error.message}. Scores will not be saved.`);
                userIdDisplay.textContent = `Error initializing Firebase.`;
                isAuthReady = false;
                initializeGame(); // Still initialize game
            }
        }

        /**
         * Initializes or resets the game board and state.
         */
        function initializeGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            gameActive = true;
            displayBoard();
            setMessage(`Player ${currentPlayer}'s turn. Enter a number (1-9) to make a move.`);
            moveInput.value = '';
            moveInput.disabled = false;
            makeMoveButton.disabled = false;
            resetGameButton.style.display = 'none';
        }

        /**
         * Displays the current state of the Tic-Tac-Toe board in a text format.
         * Updates both the console and the HTML display.
         * @param {Array} currentBoard - The board array to display. Defaults to global 'board'.
         */
        function displayBoard(currentBoard = board) {
            const displayBoardArr = currentBoard.map((cell, index) => cell === '' ? (index + 1) : cell);

            const boardString = `
 ${displayBoardArr[0]} | ${displayBoardArr[1]} | ${displayBoardArr[2]}
---+---+---
 ${displayBoardArr[3]} | ${displayBoardArr[4]} | ${displayBoardArr[5]}
---+---+---
 ${displayBoardArr[6]} | ${displayBoardArr[7]} | ${displayBoardArr[8]}
            `;
            console.log(boardString);
            boardDisplay.textContent = boardString;
        }

        /**
         * Sets the message displayed to the user.
         * @param {string} msg - The message to display.
         */
        function setMessage(msg) {
            messageDisplay.textContent = msg;
            console.log(msg);
        }

        /**
         * Handles a player's move.
         * @param {number} cellIndex - The 0-indexed position on the board (0-8).
         */
        function handleMove(cellIndex) {
            if (!gameActive || board[cellIndex] !== '') {
                setMessage("Invalid move! That cell is already taken or the game is over. Try again.");
                return;
            }

            board[cellIndex] = currentPlayer;
            displayBoard();

            if (checkWin()) {
                setMessage(`Player ${currentPlayer} wins! Congratulations!`);
                gameActive = false;
                updateScores(currentPlayer); // Update score for winner
                endGame();
            } else if (checkDraw()) {
                setMessage("It's a draw! No one wins.");
                gameActive = false;
                updateScores('Draw'); // Update score for draw
                endGame();
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                setMessage(`Player ${currentPlayer}'s turn. Enter a number (1-9) to make a move.`);
            }
        }

        /**
         * Checks if the current player has won the game.
         * @returns {boolean} - True if the current player has won, false otherwise.
         */
        function checkWin() {
            const winCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            for (const combo of winCombinations) {
                const [a, b, c] = combo;
                if (board[a] === currentPlayer && board[b] === currentPlayer && board[c] === currentPlayer) {
                    return true;
                }
            }
            return false;
        }

        /**
         * Checks if the game is a draw (board is full and no winner).
         * @returns {boolean} - True if it's a draw, false otherwise.
         */
        function checkDraw() {
            return board.every(cell => cell !== '');
        }

        /**
         * Ends the game by disabling input and showing the reset button.
         */
        function endGame() {
            moveInput.disabled = true;
            makeMoveButton.disabled = true;
            resetGameButton.style.display = 'block';
        }

        /**
         * Updates the local scores object and displays them, then saves to Firestore.
         * @param {string} winner - 'X', 'O', or 'Draw'.
         */
        function updateScores(winner) {
            scores[winner]++;
            displayScores();
            saveScoresToFirestore(); // Save updated scores to Firestore
        }

        /**
         * Displays the current scores in the HTML scoreboard.
         */
        function displayScores() {
            xWinsDisplay.textContent = scores.X;
            oWinsDisplay.textContent = scores.O;
            drawsDisplay.textContent = scores.Draw;
        }

        /**
         * Saves the current scores to Firestore.
         */
        async function saveScoresToFirestore() {
            if (!isAuthReady || !db || !userId || !scoresDocRef) {
                console.warn("Firebase not ready or user not authenticated. Scores not saved.");
                setMessage("Scores not saved. Firebase not ready or authentication failed.");
                return;
            }

            try {
                // Use setDoc with merge: true to update only the score fields
                await setDoc(scoresDocRef, scores, { merge: true });
                console.log("Scores saved to Firestore!");
            } catch (e) {
                console.error("Error saving scores: ", e);
                setMessage("Error saving scores. Check console for details.");
            }
        }

        /**
         * Loads scores from Firestore and sets up a real-time listener.
         * @param {string} currentAppId - The project ID to use for the collection path.
         */
        function loadScores(currentAppId) {
            if (!isAuthReady || !db || !userId || !currentAppId) {
                console.warn("Firebase not ready, user not authenticated, or appId missing. Cannot load scores.");
                return;
            }

            // Reference to the specific scores document for this user
            scoresDocRef = doc(db, `artifacts/${currentAppId}/users/${userId}/user_data/scores`);

            onSnapshot(scoresDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Update local scores with data from Firestore
                    const fetchedScores = docSnapshot.data();
                    scores.X = fetchedScores.X || 0;
                    scores.O = fetchedScores.O || 0;
                    scores.Draw = fetchedScores.Draw || 0;
                    console.log("Scores loaded from Firestore:", scores);
                } else {
                    // If no scores document exists, initialize it in Firestore
                    console.log("No scores document found. Initializing with zeros.");
                    scores = { X: 0, O: 0, Draw: 0 }; // Reset local scores
                    saveScoresToFirestore(); // Create the document with initial zeros
                }
                displayScores(); // Always display (or update) scores
            }, (error) => {
                console.error("Error listening to scores:", error);
                setMessage("Error loading scores. Check console for details.");
            });
        }

        // --- Event Listeners ---
        makeMoveButton.addEventListener('click', () => {
            const move = parseInt(moveInput.value);
            if (isNaN(move) || move < 1 || move > 9) {
                setMessage("Please enter a valid number between 1 and 9.");
                moveInput.value = '';
                return;
            }
            handleMove(move - 1);
            moveInput.value = '';
        });

        moveInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                makeMoveButton.click();
            }
        });

        resetGameButton.addEventListener('click', initializeGame);

        // --- Initial Setup ---
        // Initialize Firebase and then the game when the page loads
        window.onload = () => {
            initializeFirebase();
            displayScores(); // Display initial zero scores before Firebase loads
        };
    </script>
</body>
</html>
