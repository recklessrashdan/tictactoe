<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe with Score & History</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px; /* Space between main sections */
        }

        /* Game Container Styling */
        .game-container, .history-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Game Board Display */
        #game-board-display {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            font-size: 1.5em;
            line-height: 1.5;
            text-align: center;
            max-width: 300px;
            overflow-x: auto;
        }

        /* Message Display */
        #message-display {
            background-color: #e8f5e9;
            color: #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: 600;
            border: 1px solid #d4edda;
        }

        /* Input Section */
        .input-section {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .input-section label {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #555;
        }

        .input-section input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1.1em;
            width: 80px;
            text-align: center;
            -moz-appearance: textfield;
        }

        .input-section input[type="number"]::-webkit-outer-spin-button,
        .input-section input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Button Styling */
        .input-section button, .history-item button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .input-section button:hover, .history-item button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .input-section button:active, .history-item button:active {
            background-color: #21618c;
            transform: translateY(0);
        }

        .reset-button {
            background-color: #e74c3c;
            margin-top: 25px;
        }

        .reset-button:hover {
            background-color: #c0392b;
        }

        .reset-button:active {
            background-color: #922b21;
        }

        /* Scoreboard Styling */
        .scoreboard {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .score-item {
            font-size: 1.2em;
            font-weight: 600;
            color: #555;
        }

        .score-item span {
            color: #3498db;
            font-size: 1.4em;
            font-weight: 700;
            margin-left: 5px;
        }

        .score-item.x-score span { color: #e74c3c; } /* Red for X */
        .score-item.o-score span { color: #2ecc71; } /* Green for O */
        .score-item.draw-score span { color: #f39c12; } /* Orange for Draw */

        /* History Section Styling */
        .history-container {
            margin-top: 20px;
            padding-top: 0; /* Adjust padding as h2 has its own margin */
        }

        .history-container h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 700;
            padding-top: 20px; /* Space above heading */
        }

        #game-history-list {
            list-style: none;
            padding: 0;
            max-height: 300px; /* Limit height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #fdfdfd;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1em;
            color: #444;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item span {
            flex-grow: 1; /* Allow text to take available space */
            text-align: left;
        }

        .history-item button {
            padding: 8px 15px;
            font-size: 0.9em;
            margin-left: 10px;
            background-color: #1abc9c; /* Teal for replay button */
        }

        .history-item button:hover {
            background-color: #16a085;
        }

        /* User ID Display */
        #user-id-display {
            margin-top: 10px;
            font-size: 0.9em;
            color: #777;
            word-break: break-all; /* Break long IDs */
            text-align: center;
            padding: 0 10px;
        }

        /* Replay Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        #replay-board-display {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            font-size: 1.5em;
            line-height: 1.5;
            text-align: center;
            max-width: 300px;
        }

        #replay-message {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
        }

        .replay-controls button {
            background-color: #555;
            margin: 5px;
        }
        .replay-controls button:hover {
            background-color: #333;
        }
        .replay-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }


        /* Responsive adjustments */
        @media (max-width: 600px) {
            .game-container, .history-container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            #game-board-display, #replay-board-display {
                font-size: 1.2em;
                padding: 15px;
            }
            .input-section input[type="number"],
            .input-section button,
            .history-item button {
                font-size: 1em;
                padding: 10px 20px;
            }
            .scoreboard {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Tic-Tac-Toe</h1>
        <div id="user-id-display">Loading user ID...</div>
        <!-- Scoreboard -->
        <div class="scoreboard">
            <div class="score-item x-score">X Wins: <span id="x-wins">0</span></div>
            <div class="score-item o-score">O Wins: <span id="o-wins">0</span></div>
            <div class="score-item draw-score">Draws: <span id="draws">0</span></div>
        </div>

        <div id="game-board-display"></div>
        <div id="message-display">Loading game...</div>

        <div class="input-section">
            <label for="moveInput">Enter your move (1-9):</label>
            <input type="number" id="moveInput" min="1" max="9" placeholder="1-9">
            <button id="makeMoveButton">Make Move</button>
            <button id="resetGameButton" class="reset-button">Play Again</button>
        </div>
    </div>

    <div class="history-container">
        <h2>Game History</h2>
        <ul id="game-history-list">
            <li>No games played yet.</li>
        </ul>
    </div>

    <!-- Replay Modal -->
    <div id="replayModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Game Replay</h2>
            <div id="replay-message"></div>
            <div id="replay-board-display"></div>
            <div class="replay-controls">
                <button id="prevMoveButton">Previous</button>
                <button id="nextMoveButton">Next</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Game State Variables ---
        let board;
        let currentPlayer;
        let gameActive;
        let movesHistory; // To store moves for the current game before saving
        let scores = { X: 0, O: 0, Draw: 0 };
        let gameHistory = []; // Stores all past games fetched from Firestore

        // --- Firebase Variables ---
        let app;
        let db;
        let auth;
        let userId = 'loading...'; // Default until authenticated
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // --- Replay Modal Variables ---
        let replayModal;
        let replayCloseButton;
        let replayBoardDisplay;
        let replayMessage;
        let prevMoveButton;
        let nextMoveButton;
        let currentReplayGame;
        let currentReplayMoveIndex;
        let replayAnimationTimeout; // To clear any ongoing replay animation

        // --- Get References to HTML Elements ---
        const boardDisplay = document.getElementById('game-board-display');
        const messageDisplay = document.getElementById('message-display');
        const moveInput = document.getElementById('moveInput');
        const makeMoveButton = document.getElementById('makeMoveButton');
        const resetGameButton = document.getElementById('resetGameButton');
        const xWinsDisplay = document.getElementById('x-wins');
        const oWinsDisplay = document.getElementById('o-wins');
        const drawsDisplay = document.getElementById('draws');
        const gameHistoryList = document.getElementById('game-history-list');
        const userIdDisplay = document.getElementById('user-id-display');

        /**
         * Initializes Firebase and sets up authentication.
         * This runs once when the script loads.
         */
        async function initializeFirebase() {
            try {
                // Get app ID and Firebase config from global variables provided by Canvas
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    setMessage("Error: Firebase configuration missing. Cannot save history.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Load game history after authentication is ready
                        loadGameHistory();
                        initializeGame(); // Initialize game after auth and history load
                    } else {
                        // User is signed out, attempt anonymous sign-in
                        console.log("No user signed in. Attempting anonymous sign-in...");
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                // Use custom token if provided (for Canvas environment)
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                // Fallback to anonymous sign-in
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            setMessage(`Authentication Error: ${error.message}. History will not be saved.`);
                            userIdDisplay.textContent = `Error getting User ID.`;
                            isAuthReady = false;
                            initializeGame(); // Still initialize game even if auth fails
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                setMessage(`Error initializing Firebase: ${error.message}. History will not be saved.`);
                userIdDisplay.textContent = `Error initializing Firebase.`;
                isAuthReady = false;
                initializeGame(); // Still initialize game
            }
        }

        /**
         * Initializes or resets the game board and state.
         */
        function initializeGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            gameActive = true;
            movesHistory = []; // Reset moves history for the new game
            displayBoard();
            setMessage(`Player ${currentPlayer}'s turn. Enter a number (1-9) to make a move.`);
            moveInput.value = '';
            moveInput.disabled = false;
            makeMoveButton.disabled = false;
            resetGameButton.style.display = 'none';
        }

        /**
         * Displays the current state of the Tic-Tac-Toe board in a text format.
         * Updates both the console and the HTML display.
         * @param {Array} currentBoard - The board array to display. Defaults to global 'board'.
         */
        function displayBoard(currentBoard = board) {
            const displayBoardArr = currentBoard.map((cell, index) => cell === '' ? (index + 1) : cell);

            const boardString = `
 ${displayBoardArr[0]} | ${displayBoardArr[1]} | ${displayBoardArr[2]}
---+---+---
 ${displayBoardArr[3]} | ${displayBoardArr[4]} | ${displayBoardArr[5]}
---+---+---
 ${displayBoardArr[6]} | ${displayBoardArr[7]} | ${displayBoardArr[8]}
            `;
            console.log(boardString);
            boardDisplay.textContent = boardString;
        }

        /**
         * Sets the message displayed to the user.
         * @param {string} msg - The message to display.
         */
        function setMessage(msg) {
            messageDisplay.textContent = msg;
            console.log(msg);
        }

        /**
         * Handles a player's move.
         * @param {number} cellIndex - The 0-indexed position on the board (0-8).
         */
        function handleMove(cellIndex) {
            if (!gameActive || board[cellIndex] !== '') {
                setMessage("Invalid move! That cell is already taken or the game is over. Try again.");
                return;
            }

            board[cellIndex] = currentPlayer;
            // Record the move for current game's history
            movesHistory.push({ player: currentPlayer, index: cellIndex });

            displayBoard();

            if (checkWin()) {
                setMessage(`Player ${currentPlayer} wins! Congratulations!`);
                gameActive = false;
                updateScores(currentPlayer); // Update score for winner
                saveGameResult(currentPlayer); // Save game to Firestore
                endGame();
            } else if (checkDraw()) {
                setMessage("It's a draw! No one wins.");
                gameActive = false;
                updateScores('Draw'); // Update score for draw
                saveGameResult('Draw'); // Save game to Firestore
                endGame();
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                setMessage(`Player ${currentPlayer}'s turn. Enter a number (1-9) to make a move.`);
            }
        }

        /**
         * Checks if the current player has won the game.
         * @returns {boolean} - True if the current player has won, false otherwise.
         */
        function checkWin() {
            const winCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            for (const combo of winCombinations) {
                const [a, b, c] = combo;
                if (board[a] === currentPlayer && board[b] === currentPlayer && board[c] === currentPlayer) {
                    return true;
                }
            }
            return false;
        }

        /**
         * Checks if the game is a draw (board is full and no winner).
         * @returns {boolean} - True if it's a draw, false otherwise.
         */
        function checkDraw() {
            return board.every(cell => cell !== '');
        }

        /**
         * Ends the game by disabling input and showing the reset button.
         */
        function endGame() {
            moveInput.disabled = true;
            makeMoveButton.disabled = true;
            resetGameButton.style.display = 'block';
        }

        /**
         * Updates the local scores object and displays them.
         * @param {string} winner - 'X', 'O', or 'Draw'.
         */
        function updateScores(winner) {
            scores[winner]++;
            displayScores();
        }

        /**
         * Displays the current scores in the HTML scoreboard.
         */
        function displayScores() {
            xWinsDisplay.textContent = scores.X;
            oWinsDisplay.textContent = scores.O;
            drawsDisplay.textContent = scores.Draw;
        }

        /**
         * Saves the current game result to Firestore.
         * @param {string} winner - 'X', 'O', or 'Draw'.
         */
        async function saveGameResult(winner) {
            if (!isAuthReady || !db || !userId) {
                console.warn("Firebase not ready or user not authenticated. Game result not saved.");
                setMessage("Game result not saved. Firebase not ready or authentication failed.");
                return;
            }

            try {
                const gamesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/tic_tac_toe_games`);
                await addDoc(gamesCollectionRef, {
                    winner: winner,
                    timestamp: new Date(), // Store current time
                    moves: movesHistory, // Store the sequence of moves
                    finalBoard: board // Store the final state of the board
                });
                console.log("Game result saved to Firestore!");
            } catch (e) {
                console.error("Error adding document: ", e);
                setMessage("Error saving game history. Check console for details.");
            }
        }

        /**
         * Loads game history from Firestore and sets up a real-time listener.
         */
        function loadGameHistory() {
            if (!isAuthReady || !db || !userId) {
                console.warn("Firebase not ready or user not authenticated. Cannot load history.");
                return;
            }

            const gamesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/tic_tac_toe_games`);
            const q = query(gamesCollectionRef, orderBy("timestamp", "desc")); // Order by most recent first

            onSnapshot(q, (snapshot) => {
                gameHistory = []; // Clear current history
                scores = { X: 0, O: 0, Draw: 0 }; // Reset scores to recalculate
                snapshot.forEach((doc) => {
                    const gameData = doc.data();
                    gameHistory.push({ id: doc.id, ...gameData }); // Add document ID and data
                    // Recalculate scores from fetched history
                    scores[gameData.winner]++;
                });
                displayScores();
                displayGameHistory();
                console.log("Game history loaded/updated from Firestore.");
            }, (error) => {
                console.error("Error listening to game history:", error);
                setMessage("Error loading game history. Check console for details.");
            });
        }

        /**
         * Displays the loaded game history in the HTML list.
         */
        function displayGameHistory() {
            gameHistoryList.innerHTML = ''; // Clear existing list items

            if (gameHistory.length === 0) {
                gameHistoryList.innerHTML = '<li>No games played yet.</li>';
                return;
            }

            gameHistory.forEach((game, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('history-item');

                // Format timestamp
                const date = game.timestamp.toDate ? game.timestamp.toDate() : new Date(game.timestamp);
                const formattedDate = date.toLocaleString(); // e.g., "7/10/2025, 6:30:00 PM"

                listItem.innerHTML = `
                    <span>Game ${gameHistory.length - index}: Winner: ${game.winner} (${formattedDate})</span>
                    <button data-game-id="${game.id}">Replay</button>
                `;
                gameHistoryList.appendChild(listItem);
            });

            // Add event listeners to replay buttons
            document.querySelectorAll('.history-item button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const gameIdToReplay = event.target.dataset.gameId;
                    const gameToReplay = gameHistory.find(game => game.id === gameIdToReplay);
                    if (gameToReplay) {
                        openReplayModal(gameToReplay);
                    }
                });
            });
        }

        // --- Replay Modal Functions ---

        /**
         * Initializes replay modal elements.
         */
        function initializeReplayModal() {
            replayModal = document.getElementById('replayModal');
            replayCloseButton = replayModal.querySelector('.close-button');
            replayBoardDisplay = document.getElementById('replay-board-display');
            replayMessage = document.getElementById('replay-message');
            prevMoveButton = document.getElementById('prevMoveButton');
            nextMoveButton = document.getElementById('nextMoveButton');

            replayCloseButton.addEventListener('click', closeReplayModal);
            window.addEventListener('click', (event) => {
                if (event.target === replayModal) {
                    closeReplayModal();
                }
            });

            prevMoveButton.addEventListener('click', showPreviousReplayMove);
            nextMoveButton.addEventListener('click', showNextReplayMove);
        }

        /**
         * Opens the replay modal with a specific game's data.
         * @param {Object} gameData - The game object from history.
         */
        function openReplayModal(gameData) {
            currentReplayGame = gameData;
            currentReplayMoveIndex = -1; // Start before the first move (empty board)
            replayModal.style.display = 'flex'; // Show modal
            clearReplayAnimation(); // Clear any previous animation
            showReplayMove(); // Display initial state
        }

        /**
         * Closes the replay modal.
         */
        function closeReplayModal() {
            replayModal.style.display = 'none';
            clearReplayAnimation();
            currentReplayGame = null;
        }

        /**
         * Displays the current move in the replay.
         */
        function showReplayMove() {
            const tempBoard = ['', '', '', '', '', '', '', '', ''];
            const moves = currentReplayGame.moves || [];

            // Apply moves up to the current index to the temporary board
            for (let i = 0; i <= currentReplayMoveIndex; i++) {
                if (moves[i]) {
                    tempBoard[moves[i].index] = moves[i].player;
                }
            }

            displayBoard(tempBoard); // Use the replay board display
            replayBoardDisplay.textContent = boardDisplay.textContent; // Copy current board display content

            if (currentReplayMoveIndex === -1) {
                replayMessage.textContent = "Game Start (Empty Board)";
            } else if (currentReplayMoveIndex < moves.length) {
                const currentMove = moves[currentReplayMoveIndex];
                replayMessage.textContent = `Move ${currentReplayMoveIndex + 1}: Player ${currentMove.player} placed at ${currentMove.index + 1}`;
            } else {
                replayMessage.textContent = `Game Over. Winner: ${currentReplayGame.winner}`;
            }

            // Enable/disable navigation buttons
            prevMoveButton.disabled = currentReplayMoveIndex <= -1;
            nextMoveButton.disabled = currentReplayMoveIndex >= moves.length;
        }

        /**
         * Shows the previous move in the replay.
         */
        function showPreviousReplayMove() {
            if (currentReplayMoveIndex > -1) {
                currentReplayMoveIndex--;
                showReplayMove();
            }
        }

        /**
         * Shows the next move in the replay.
         */
        function showNextReplayMove() {
            if (currentReplayMoveIndex < (currentReplayGame.moves || []).length) {
                currentReplayMoveIndex++;
                showReplayMove();
            }
        }

        /**
         * Clears any ongoing replay animation timeout.
         */
        function clearReplayAnimation() {
            if (replayAnimationTimeout) {
                clearTimeout(replayAnimationTimeout);
                replayAnimationTimeout = null;
            }
        }

        // --- Event Listeners ---
        makeMoveButton.addEventListener('click', () => {
            const move = parseInt(moveInput.value);
            if (isNaN(move) || move < 1 || move > 9) {
                setMessage("Please enter a valid number between 1 and 9.");
                moveInput.value = '';
                return;
            }
            handleMove(move - 1);
            moveInput.value = '';
        });

        moveInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                makeMoveButton.click();
            }
        });

        resetGameButton.addEventListener('click', initializeGame);

        // --- Initial Setup ---
        // Initialize Firebase and then the game when the page loads
        window.onload = () => {
            initializeFirebase();
            initializeReplayModal(); // Setup modal elements and listeners
            displayScores(); // Display initial zero scores
        };
    </script>
</body>
</html>
